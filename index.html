<!DOCTYPE html>
<html>
<head>
    <title>Trust Bazaar Debug</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
        body { background: #673ab7; color: white; font-family: sans-serif; text-align: center; padding-top: 30px; }
        .box { background: white; color: black; margin: 15px; padding: 20px; border-radius: 10px; }
        button { padding: 15px; width: 90%; border: none; border-radius: 5px; font-weight: bold; margin: 5px 0; cursor: pointer; }
        .btn-pay { background: #4CAF50; color: white; font-size: 18px; }
        .btn-reset { background: #ff9800; color: white; font-size: 14px; }
        #logs { font-family: monospace; font-size: 11px; color: #00ff00; background: #000; padding: 10px; margin: 20px; height: 150px; overflow-y: auto; text-align: left; }
    </style>
</head>
<body>

    <h2>Trust Bazaar V2</h2>
    
    <div class="box">
        <p>User: <span id="user">Loading...</span></p>
        <button class="btn-pay" onclick="payPi()">üíé Pay 1 Pi (Start Audit)</button>
        <hr>
        <button class="btn-reset" onclick="clearStuckPayments()">‚ö†Ô∏è Fix "Preparing" Timeout</button>
    </div>

    <div id="logs"><b>> SYSTEM READY</b></div>

    <script>
        const log = (m) => { 
            const d = document.getElementById('logs');
            d.innerHTML += "<div>> " + m + "</div>"; 
            d.scrollTop = d.scrollHeight;
        }

        // 1. CLEAR STUCK PAYMENTS (The Fix for Timeouts)
        function clearStuckPayments() {
            log("üßπ Scanning for stuck payments...");
            const onIncomplete = (payment) => {
                log("‚ö†Ô∏è Found stuck ID: " + payment.identifier);
                Pi.payment.complete(payment.identifier)
                    .then(() => log("‚úÖ Cleared! Try paying again."))
                    .catch((e) => log("‚ùå Clear failed: " + e.message));
            };
            // Trigger the check
            Pi.authenticate(['username', 'payments'], onIncomplete).then(() => log("scan complete."));
        }

        // 2. START SYSTEM
        window.onload = function() {
            try {
                Pi.init({ version: "2.0" });
                log("SDK Init.");
                Pi.authenticate(['username', 'payments'], (p) => { log("Found incomplete: " + p.identifier); })
                    .then(auth => {
                        document.getElementById('user').innerText = auth.user.username;
                        log("Signed in: " + auth.user.username);
                    })
                    .catch(e => log("Auth Error: " + e.message));
            } catch(e) { log("Fatal: " + e.message); }
        };

        // 3. PAY (With Unique ID to prevent hangs)
        function payPi() {
            const uniqueID = "audit-" + Date.now(); // <--- THIS PREVENTS DUPLICATE HANGS
            log("üíé Starting Payment: " + uniqueID);

            Pi.createPayment({
                amount: 1.0,
                memo: "Trust Audit Fee",
                metadata: { internalId: uniqueID } 
            }, {
                onReadyForServerApproval: function(paymentId) {
                    log("üì° Payment ID: " + paymentId);
                    log("‚è≥ WAITING FOR PC APPROVAL...");
                    log("üëâ Check your PC Screen now!");
                },
                onReadyForServerCompletion: function(paymentId, txid) {
                    log("‚úÖ SUCCESS! TX: " + txid.substring(0,5));
                    alert("Audit Complete! Score: 88%");
                },
                onCancel: function() { log("‚ö†Ô∏è Cancelled."); },
                onError: function(e) { log("‚ùå Error: " + e.message); }
            });
        }
    </script>
</body>
</html>