<!DOCTYPE html>
<html>
<head>
    <title>Trust Bazaar Ultimate</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { background: #f4f7f6; font-family: sans-serif; margin: 0; padding-bottom: 70px; -webkit-tap-highlight-color: transparent; }
        
        /* HEADER */
        header { background: linear-gradient(135deg, #673ab7, #512da8); color: white; padding: 15px; text-align: center; position: sticky; top:0; z-index: 10; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        
        /* NAVIGATION */
        .nav-bar { display: flex; justify-content: space-around; background: white; padding: 12px; position: fixed; bottom: 0; width: 100%; border-top: 1px solid #eee; z-index: 20; }
        .nav-btn { background: none; border: none; font-size: 24px; color: #bbb; transition: 0.2s; }
        .nav-btn.active { color: #673ab7; transform: scale(1.1); }

        /* VIEWS */
        .view { display: none; padding: 15px; animation: fade 0.3s; }
        .view.active { display: block; }

        /* CARDS */
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; border: 1px solid #f0f0f0; }
        .job-card { border-left: 5px solid #673ab7; position: relative; }
        
        /* SCORE CIRCLE */
        .score-circle {
            width: 130px; height: 130px; border-radius: 50%; border: 8px solid #ddd;
            display: flex; align-items: center; justify-content: center;
            margin: 10px auto; font-size: 35px; font-weight: bold; color: #333;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
            transition: border-color 1s ease;
        }

        /* BUTTONS */
        .btn-main { background: #673ab7; color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; width: 100%; font-size: 16px; margin-top: 10px; }
        .btn-action { background: #ede7f6; color: #673ab7; border: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; font-size: 13px; float: right; }
        .btn-action:active { background: #d1c4e9; }

        /* FORMS */
        input, textarea { width: 90%; padding: 15px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; background: #fafafa; display: block; }
        input:focus, textarea:focus { outline: none; border-color: #673ab7; background: white; }

        /* MODAL OVERLAY (The Certificate) */
        #cert-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 999; text-align: center;
            flex-direction: column; justify-content: center; align-items: center;
            animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .cert-box { background: white; padding: 30px; border-radius: 20px; width: 80%; max-width: 350px; border-top: 6px solid #4CAF50; }

        @keyframes fade { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
        @keyframes pop { from { opacity:0; transform: scale(0.8); } to { opacity:1; transform: scale(1); } }
    </style>
</head>
<body>

    <header>
        <h2 style="margin:0; font-weight: 800;">Trust Bazaar</h2>
        <small id="username" style="opacity: 0.8;">Connecting...</small>
    </header>

    <div id="view-market" class="view active">
        <h3 style="color:#444;">üî• Active Jobs</h3>
        <div id="job-feed"></div>
    </div>

    <div id="view-post" class="view">
        <h3 style="color:#444;">üìù Post New Job</h3>
        <div class="card">
            <p style="color:#666; font-size:13px; margin-top:0;">Posting boosts your Trust Score by 5%.</p>
            <input type="text" id="job-title" placeholder="Job Title (e.g. Logo Design)">
            <input type="number" id="job-price" placeholder="Budget (Pi)">
            <textarea id="job-desc" rows="3" placeholder="Describe requirements..."></textarea>
            <button class="btn-main" onclick="postNewJob()">Publish Job</button>
        </div>
    </div>

    <div id="view-profile" class="view">
        <div class="card" style="text-align: center;">
            <h3 style="margin:0; color:#555;">Reputation Score</h3>
            <div id="score-ring" class="score-circle">
                <span id="trust-score">--%</span>
            </div>
            <p id="score-status" style="color:#673ab7; font-weight:bold; margin:0;">Analyzing...</p>
            
            <div style="display:flex; justify-content:space-around; margin-top:25px; background:#f9f9f9; padding:15px; border-radius:10px;">
                <div><div id="stat-posted" style="font-size:24px; font-weight:bold;">0</div><small>Posted</small></div>
                <div style="border-right:1px solid #ddd;"></div>
                <div><div id="stat-applied" style="font-size:24px; font-weight:bold;">0</div><small>Applied</small></div>
            </div>
            
            <button onclick="resetStats()" style="background:transparent; color:#ff5252; border:none; margin-top:15px; font-size:12px; text-decoration:underline;">Reset Data</button>
        </div>
    </div>

    <div id="cert-overlay">
        <div class="cert-box">
            <div style="font-size:60px; margin-bottom:10px;">üõ°Ô∏è</div>
            <h1 style="color:#4CAF50; margin:0;">PAYMENT SUCCESS</h1>
            <p style="color:#666;">Trust Score Updated</p>
            <div style="background:#f1f8e9; padding:10px; border-radius:8px; margin:15px 0; font-family:monospace;">
                TX: <span id="cert-tx">...</span>
            </div>
            <button class="btn-main" onclick="closeCert()" style="margin:0; background:#4CAF50;">Continue</button>
        </div>
    </div>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="switchView('market')">üè†</button>
        <button class="nav-btn" onclick="switchView('post')">‚ûï</button>
        <button class="nav-btn" onclick="switchView('profile')">üë§</button>
    </div>

    <script>
        // --- 1. DATA STORE (LocalStorage) ---
        let myJobs = JSON.parse(localStorage.getItem('trustJobs')) || [
            { title: "Smart Contract Audit", price: 100, user: "CoreTeam" },
            { title: "App Translation", price: 25, user: "Mod_Chris" }
        ];
        
        let userStats = JSON.parse(localStorage.getItem('trustStats')) || { posted: 0, applied: 0 };

        // --- 2. PAYMENT ENGINE (The Real Logic) ---
        function payPi(amount, memo, onSuccess) {
            const uniqueID = "tx-" + Date.now();
            console.log("üíé Paying " + amount + " Pi for " + memo);

            Pi.createPayment({
                amount: amount,
                memo: memo,
                metadata: { internalId: uniqueID } 
            }, {
                onReadyForServerApproval: function(paymentId) {
                    console.log("Waiting for approval...");
                    // SIMULATION BYPASS for GitHub Pages
                    setTimeout(() => {
                        onSuccess("SIMULATED-" + paymentId.substring(0,8));
                    }, 3000);
                },
                onReadyForServerCompletion: function(paymentId, txid) {
                    onSuccess(txid);
                },
                onCancel: function() { alert("Payment Cancelled"); },
                onError: function(e) { console.log(e); }
            });
        }

        // --- 3. MARKET ACTIONS ---
        function apply(jobTitle) {
            if(confirm("Pay 1 Pi Deposit to apply for: " + jobTitle + "?")) {
                // Call the Payment Engine
                payPi(1.0, "Apply: " + jobTitle, (txid) => {
                    // ON SUCCESS:
                    userStats.applied += 1;
                    saveData();
                    showCert(txid); // Show the fancy certificate
                });
            }
        }

        function postNewJob() {
            const title = document.getElementById('job-title').value;
            const price = document.getElementById('job-price').value;
            const user = document.getElementById('username').innerText;

            if(!title || !price) return alert("Please fill all fields");

            myJobs.unshift({ title: title, price: price, user: user });
            userStats.posted += 1;
            saveData();

            alert("‚úÖ Job Posted! (+5% Trust)");
            document.getElementById('job-title').value = "";
            document.getElementById('job-price').value = "";
            switchView('market');
        }

        // --- 4. SCORING ALGORITHM ---
        function updateScore() {
            let score = 60; // Base
            score += (userStats.posted * 5);
            score += (userStats.applied * 2);
            if(score > 100) score = 100;

            document.getElementById('trust-score').innerText = score + "%";
            document.getElementById('stat-posted').innerText = userStats.posted;
            document.getElementById('stat-applied').innerText = userStats.applied;

            const ring = document.getElementById('score-ring');
            if(score < 70) { ring.style.borderColor = "#ff9800"; document.getElementById('score-status').innerText = "Member"; }
            else if(score < 90) { ring.style.borderColor = "#2196f3"; document.getElementById('score-status').innerText = "Established"; }
            else { ring.style.borderColor = "#4CAF50"; document.getElementById('score-status').innerText = "üåü VERIFIED"; }
        }

        // --- 5. UTILS ---
        function saveData() {
            localStorage.setItem('trustJobs', JSON.stringify(myJobs));
            localStorage.setItem('trustStats', JSON.stringify(userStats));
            updateScore();
        }

        function switchView(viewName) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + viewName).classList.add('active');
            
            // Highlight icon
            const btnIndex = ['market', 'post', 'profile'].indexOf(viewName);
            document.querySelectorAll('.nav-btn')[btnIndex].classList.add('active');

            if(viewName === 'market') renderFeed();
            if(viewName === 'profile') updateScore();
        }

        function renderFeed() {
            const feed = document.getElementById('job-feed');
            feed.innerHTML = "";
            myJobs.forEach(job => {
                feed.innerHTML += `
                    <div class="card job-card">
                        <button class="btn-action" onclick="apply('${job.title}')">APPLY</button>
                        <h4 style="margin:0 0 5px 0;">${job.title}</h4>
                        <div style="color:#673ab7; font-weight:bold;">${job.price} œÄ</div>
                        <small style="color:#888;">Posted by: ${job.user}</small>
                    </div>
                `;
            });
        }

        function showCert(txid) {
            document.getElementById('cert-tx').innerText = txid;
            document.getElementById('cert-overlay').style.display = 'flex';
            if(navigator.vibrate) navigator.vibrate([50,50,50]);
        }

        function closeCert() {
            document.getElementById('cert-overlay').style.display = 'none';
            switchView('profile'); // Take them to profile to see new score
        }

        function resetStats() {
            if(confirm("Reset all data?")) {
                userStats = { posted: 0, applied: 0 };
                saveData();
                alert("Reset Complete.");
            }
        }

        // --- 6. BOOTLOADER ---
        window.onload = function() {
            renderFeed();
            try {
                Pi.init({ version: "2.0" });
                Pi.authenticate(['username', 'payments'], (p) => { Pi.payment.complete(p.identifier); })
                    .then(auth => { document.getElementById('username').innerText = auth.user.username; });
            } catch(e) {}
        };
    </script>
</body>
</html>