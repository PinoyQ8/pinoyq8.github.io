<script>
        // 1. Mandatory Global Callback - CRITICAL FOR TIMEOUTS
        const onIncompletePaymentFound = (payment) => {
            log("‚ö†Ô∏è Incomplete payment found. Resolving...");
            // Automatically tries to complete any "stuck" payments
            try {
                Pi.payment.complete(payment.identifier);
                log("‚úÖ Ghost payment cleared.");
            } catch(e) {
                log("‚ÑπÔ∏è No stuck payments to clear.");
            }
        };

        const log = (msg) => {
            const output = document.getElementById('log-output');
            if (output) {
                output.innerHTML += `<div>> ${msg}</div>`;
                output.scrollTop = output.scrollHeight;
            }
        };

        // 2. The Bootloader
        function startSystem() {
            log("üì° System Booting...");

            setTimeout(() => {
                const loader = document.getElementById('loader-container');
                if (loader) loader.style.display = 'none';
            }, 5000);

            try {
                log("üîó Connecting to SDK...");
                Pi.init({ version: "2.0" });
                
                Pi.authenticate(['username', 'payments'], onIncompletePaymentFound)
                    .then(function (auth) {
                        log("üë§ Welcome, " + auth.user.username);
                        document.getElementById('user-name').innerText = auth.user.username;
                        document.getElementById('loader-container').style.display = 'none';
                    })
                    .catch(function (err) {
                        log("‚ùå SDK Auth Error: " + err.message);
                    });
            } catch (e) {
                log("‚ùå Fatal Error: " + e.message);
            }
        }

        // 3. PI PAYMENT LOGIC (Updated for S23 Timeouts)
        function requestTrustPayment() {
            log("üíé Opening Wallet...");

            Pi.createPayment({
                amount: 1.0,
                memo: "Trust Protocol L1 Audit Fee",
                metadata: { auditId: "TB-L1-AUDIT" },
            }, {
                onReadyForServerApproval: function(paymentId) {
                    log("üì° Handshake Created: " + paymentId);
                    // In a Sandbox/Front-end only app, we wait here.
                    // If it stays "Preparing", ensure your Sandbox code matches S23.
                    log("‚è≥ Waiting for Pi Server to Approve...");
                },
                onReadyForServerCompletion: function(paymentId, txid) {
                    log("‚úÖ PAYMENT VERIFIED!");
                    log("üîó TX: " + txid.substring(0, 10));
                    startAudit(); 
                },
                onCancel: function(paymentId) {
                    log("‚ö†Ô∏è Payment Cancelled.");
                },
                onError: function(error, payment) {
                    log("‚ùå Wallet Error: " + error.message);
                    // If timeout occurs, try to clear it
                    if(payment) onIncompletePaymentFound(payment);
                }
            });
        }

        // 4. AUDIT ANIMATION
        function startAudit() {
            log("üõ°Ô∏è SECURITY SCAN INITIATED...");
            const card = document.querySelector('.card');
            card.innerHTML = `
                <h2 style="color: var(--pi-purple);">Audit in Progress...</h2>
                <div style="width: 100%; background: #eee; height: 15px; border-radius: 10px; margin: 20px 0; overflow: hidden;">
                    <div id="audit-bar" style="width: 0%; background: var(--pi-purple); height: 100%; transition: width 0.3s ease;"></div>
                </div>
                <p id="audit-status" style="font-style: italic; color: #666;">Analyzing wallet history...</p>
            `;

            const statuses = ["Analyzing age...", "Checking velocity...", "Verifying network...", "Calculating Score..."];
            let progress = 0;
            const interval = setInterval(() => {
                progress += 5;
                const bar = document.getElementById('audit-bar');
                if (bar) bar.style.width = progress + "%";
                if (progress % 25 === 0 && progress < 100) {
                    document.getElementById('audit-status').innerText = statuses[progress / 25];
                }
                if (progress >= 100) {
                    clearInterval(interval);
                    showFinalResult();
                }
            }, 150);
        }

        function showFinalResult() {
            const card = document.querySelector('.card');
            const currentUser = document.getElementById('user-name').innerText;
            card.style.border = "4px solid #4caf50";
            card.innerHTML = `
                <div style="padding: 20px;">
                    <h1 style="color: #4caf50; font-size: 50px; margin: 0;">88%</h1>
                    <h3 style="margin-top: 0;">TRUST SCORE VERIFIED</h3>
                    <hr>
                    <p>User: <b>${currentUser || 'Pinoy'}</b></p>
                    <button onclick="location.reload()" style="background: var(--pi-purple); color: white; border: none; padding: 10px 20px; border-radius: 5px; width: 100%; font-weight: bold; cursor: pointer;">Issue New Audit</button>
                </div>
            `;
            log("üèÜ Audit Complete: 88% Score Issued.");
        }

        function checkWalletEligibility() {
            log("üîç Refreshing Handshake...");
            startSystem();
        }

        if (document.readyState === "complete") { startSystem(); } 
        else { window.addEventListener("load", startSystem); }
    </script>